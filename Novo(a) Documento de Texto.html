<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Vendas — Luk Vendas</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--accent:#0f62fe;--muted:#6b7280}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:24px;color:#111}
    .container{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:14px}
    .logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#0366d6);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(15,35,60,0.06);}
    form{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;align-items:end}
    label{font-size:12px;color:var(--muted)}
    input,select{width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
    .full{grid-column:span 6}
    .span2{grid-column:span 2}
    .span3{grid-column:span 3}
    .actions{display:flex;gap:8px}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eef2f6;text-align:left;font-size:14px}
    tfoot td{font-weight:700}
    .right{text-align:right}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .img-preview{max-width:48px;max-height:48px;border-radius:6px;object-fit:cover}
    .flex{display:flex;gap:8px;align-items:center}
    .pill{background:#f1f5f9;padding:6px 8px;border-radius:999px;font-size:13px}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    @media (max-width:900px){form{grid-template-columns:repeat(2,1fr)}.span3{grid-column:span 2}.span2{grid-column:span 2}.full{grid-column:span 2}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">LV</div>
        <div>
          <h1 style="margin:0">Luk Vendas</h1>
          <div class="muted small">Registro de vendas — simples, offline e exportável</div>
        </div>
      </div>
      <div class="pill">Versão: 1.0 • Offline</div>
    </header>

    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title">Registrar venda</h2>
      <form id="saleForm">
        <div>
          <label for="date">Data</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label for="product">Produto / Serviço</label>
          <input type="text" id="product" placeholder="Ex: Camiseta" required />
        </div>
        <div>
          <label for="quantity">Quantidade</label>
          <input type="number" id="quantity" min="1" value="1" required />
        </div>
        <div>
          <label for="unitPrice">Preço unitário (R$)</label>
          <input type="number" id="unitPrice" min="0" step="0.01" value="0.00" required />
        </div>
        <div>
          <label for="client">Cliente (opcional)</label>
          <input type="text" id="client" placeholder="Nome do cliente" />
        </div>
        <div>
          <label for="receipt">Comprovante (opcional)</label>
          <input type="file" id="receipt" accept="image/*,application/pdf" />
        </div>

        <div class="span3">
          <label>Total calculado</label>
          <div class="flex">
            <div class="pill" id="calculatedTotal">R$ 0,00</div>
            <div class="muted small">O total é atualizado automaticamente.</div>
          </div>
        </div>

        <div class="actions full">
          <button type="submit">Adicionar venda</button>
          <button type="button" id="clearForm" class="ghost">Limpar</button>
          <button type="button" id="exportCsv" class="ghost">Exportar CSV</button>
          <button type="button" id="exportJson" class="ghost">Salvar JSON</button>
          <button type="button" id="importJson" class="ghost">Importar JSON</button>
        </div>
      </form>
    </section>

    <section style="margin-top:16px" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:0">Vendas registradas</h2>
        <div class="muted small">Total de registros: <span id="count">0</span></div>
      </div>

      <div id="tableWrap"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div class="muted small">Salvamento automático: <span id="autosave">—</span></div>
        <div class="actions">
          <button id="downloadAllJson" class="ghost">Baixar tudo (JSON)</button>
          <button id="downloadAllCsv" class="ghost">Baixar tudo (CSV)</button>
          <button id="clearAll" class="ghost">Apagar tudo</button>
        </div>
      </div>
    </section>

  </div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />

  <script>
    // Estado
    const COMPANY = 'Luk Vendas'
    const storageKey = 'lukvendas_sales_v1'
    let sales = []

    // Helpers
    const $ = id => document.getElementById(id)
    const formatBRL = v => 'R$ ' + Number(v).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})
    const nowTimestamp = () => new Date().toISOString().replace(/[:.]/g,'-')

    // Load
    function load() {
      try {
        const raw = localStorage.getItem(storageKey)
        if (raw) sales = JSON.parse(raw)
      } catch(e){ console.error(e); sales = [] }
      render()
    }

    // Save
    function save(autosave=false){
      localStorage.setItem(storageKey, JSON.stringify(sales))
      $('autosave').textContent = autosave ? new Date().toLocaleString() : 'manual'
    }

    // Add sale
    function addSale(sale){
      sale.id = 'V' + (Math.floor(Math.random()*900000)+100000)
      sales.push(sale)
      save(true)
      render()
    }

    // Delete
    function deleteSale(id){
      if (!confirm('Excluir esta venda?')) return
      sales = sales.filter(s => s.id !== id)
      save(true)
      render()
    }

    // Edit inline (simple)
    function editSale(id){
      const s = sales.find(x=>x.id===id)
      if(!s) return
      $('date').value = s.date
      $('product').value = s.product
      $('quantity').value = s.quantity
      $('unitPrice').value = s.unitPrice
      $('client').value = s.client || ''
      window.scrollTo({top:0,behavior:'smooth'})
      // remove original so submit will re-add
      sales = sales.filter(x=>x.id!==id)
      save(true)
      render()
    }

    // Render table
    function render(){
      $('count').textContent = sales.length
      const wrap = $('tableWrap')
      if (sales.length === 0){
        wrap.innerHTML = '<div class="empty">Nenhuma venda registrada ainda.</div>'
        return
      }
      let html = '<table><thead><tr><th>ID</th><th>Data</th><th>Produto</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Cliente</th><th>Comprovante</th><th></th></tr></thead><tbody>'
      let sum = 0
      for(const s of sales){
        const total = Number(s.quantity) * Number(s.unitPrice)
        sum += total
        const preview = s.receipt ? (s.receiptType && s.receiptType.startsWith('image') ? `<img src="${s.receipt}" class="img-preview"/>` : `<a href="${s.receipt}" target="_blank">PDF</a>`) : ''
        html += `<tr>
          <td class="small">${s.id}</td>
          <td>${s.date}</td>
          <td>${escapeHtml(s.product)}</td>
          <td class="right">${s.quantity}</td>
          <td class="right">${formatBRL(s.unitPrice)}</td>
          <td class="right">${formatBRL(total)}</td>
          <td>${escapeHtml(s.client||'')}</td>
          <td>${preview}</td>
          <td class="right">
            <div class="actions">
              <button class="ghost" onclick="viewJson('${s.id}')">JSON</button>
              <button class="ghost" onclick="editSale('${s.id}')">Editar</button>
              <button class="ghost" onclick="deleteSale('${s.id}')">Excluir</button>
            </div>
          </td>
        </tr>`
      }
      html += `</tbody><tfoot><tr><td colspan="5" class="right">TOTAL</td><td class="right">${formatBRL(sum)}</td><td colspan="3"></td></tr></tfoot></table>`
      wrap.innerHTML = html
    }

    // Escape helper
    function escapeHtml(text){ if(!text) return '';
      return text.replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\\':'&#92;','"':'&quot;'}[c]))
    }

    // View single JSON
    function viewJson(id){
      const s = sales.find(x=>x.id===id)
      if(!s) return
      const blob = new Blob([JSON.stringify(s, null, 2)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const w = window.open(url, '_blank')
      setTimeout(()=>URL.revokeObjectURL(url), 1000*60)
    }

    // Form handling
    const form = $('saleForm')
    const receiptInput = $('receipt')
    let receiptData = null
    receiptInput.addEventListener('change', async e=>{
      const f = e.target.files[0]
      if(!f) { receiptData = null; return }
      if(f.type.startsWith('image') || f.type === 'application/pdf'){
        receiptData = await fileToDataURL(f)
        receiptDataType = f.type
      } else { alert('Tipo de arquivo não suportado'); receiptInput.value = '' }
    })

    function fileToDataURL(file){
      return new Promise(resolve=>{
        const r = new FileReader()
        r.onload = () => resolve(r.result)
        r.readAsDataURL(file)
      })
    }

    form.addEventListener('input', ()=>{
      const q = Number($('quantity').value||0)
      const p = Number($('unitPrice').value||0)
      $('calculatedTotal').textContent = formatBRL(q*p)
    })

    form.addEventListener('submit', e=>{
      e.preventDefault()
      const date = $('date').value
      const product = $('product').value.trim()
      const quantity = Number($('quantity').value)
      const unitPrice = Number($('unitPrice').value)
      const client = $('client').value.trim()
      if(!date || !product || !quantity || isNaN(unitPrice)) { alert('Preencha os campos obrigatórios corretamente.'); return }
      const sale = { date, product, quantity, unitPrice, client, receipt: receiptData || null, receiptType: receiptData ? receiptData.split(';')[0].replace('data:','') : null }
      addSale(sale)
      form.reset(); receiptData = null; $('calculatedTotal').textContent = formatBRL(0)
    })

    $('clearForm').addEventListener('click', ()=>{ form.reset(); receiptData = null; $('calculatedTotal').textContent = formatBRL(0) })

    // Export CSV
    function toCsv(items){
      const header = ['id','date','product','quantity','unitPrice','total','client']
      const rows = items.map(s=>[
        s.id,
        s.date,
        '"'+String(s.product).replace(/"/g,'""')+'"',
        s.quantity,
        s.unitPrice,
        (Number(s.quantity)*Number(s.unitPrice)).toFixed(2),
        '"'+String(s.client||'').replace(/"/g,'""')+'"'
      ].join(','))
      return header.join(',') + '\n' + rows.join('\n')
    }

    $('exportCsv').addEventListener('click', ()=>{
      if(!sales.length){ alert('Nenhuma venda para exportar'); return }
      downloadBlob(toCsv(sales), 'text/csv', `luk-vendas-${nowTimestamp()}.csv`)
    })

    $('exportJson').addEventListener('click', ()=>{
      if(!sales.length){ alert('Nenhuma venda para salvar'); return }
      downloadBlob(JSON.stringify(sales, null, 2), 'application/json', `luk-vendas-${nowTimestamp()}.json`)
    })

    $('downloadAllJson').addEventListener('click', ()=>$('exportJson').click())
    $('downloadAllCsv').addEventListener('click', ()=>$('exportCsv').click())

    function downloadBlob(content, type, filename){
      const blob = new Blob([content], {type})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url; a.download = filename
      document.body.appendChild(a); a.click(); a.remove()
      setTimeout(()=>URL.revokeObjectURL(url), 1000*60)
    }

    // Import
    $('importJson').addEventListener('click', ()=>$('importFile').click())
    $('importFile').addEventListener('change', async e=>{
      const f = e.target.files[0]
      if(!f) return
      try{
        const text = await f.text()
        const data = JSON.parse(text)
        if(Array.isArray(data)){
          // Merge but avoid id collision
          const existingIds = new Set(sales.map(s=>s.id))
          for(const item of data){ if(!item.id || existingIds.has(item.id)) item.id = 'V'+(Math.floor(Math.random()*900000)+100000); sales.push(item) }
          save(true); render(); alert('Importação concluída')
        } else alert('Arquivo JSON inválido (esperado array)')
      } catch(err){ alert('Erro ao importar: '+err.message) }
    })

    // Clear all
    $('clearAll').addEventListener('click', ()=>{
      if(!confirm('Apagar TODOS os registros? Esta ação não pode ser desfeita.')) return
      sales = []
      localStorage.removeItem(storageKey)
      render()
    })

    // Utilities
    function downloadFile(content, mime, name){ downloadBlob(content, mime, name) }

    // Init
    load()
  </script>
</body>
</html>
